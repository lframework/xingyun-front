"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.msgQueue=exports.default=exports.allActivedModals=void 0;var _conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=_interopRequireDefault(require("../../mixins/size")),_xeUtils=_interopRequireDefault(require("xe-utils")),_utils=_interopRequireWildcard(require("../../tools/utils")),_dom=_interopRequireDefault(require("../../tools/dom")),_event=require("../../tools/event"),_log=require("../../tools/log");function _getRequireWildcardCache(t){if("function"!=typeof WeakMap)return null;var e=new WeakMap,o=new WeakMap;return(_getRequireWildcardCache=function(t){return t?o:e})(t)}function _interopRequireWildcard(t,e){if(!e&&t&&t.__esModule)return t;if(null===t||"object"!==_typeof(t)&&"function"!=typeof t)return{default:t};var o=_getRequireWildcardCache(e);if(o&&o.has(t))return o.get(t);var i={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in t)if("default"!==s&&Object.prototype.hasOwnProperty.call(t,s)){var a=n?Object.getOwnPropertyDescriptor(t,s):null;a&&(a.get||a.set)?Object.defineProperty(i,s,a):i[s]=t[s]}return i.default=t,o&&o.set(t,i),i}function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var o=Object.prototype.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var o=0,i=new Array(e);o<e;o++)i[o]=t[o];return i}function _iterableToArrayLimit(t,e){var o=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=o){var i,n,s=[],a=!0,l=!1;try{for(o=o.call(t);!(a=(i=o.next()).done)&&(s.push(i.value),!e||s.length!==e);a=!0);}catch(t){l=!0,n=t}finally{try{a||null==o.return||o.return()}finally{if(l)throw n}}return s}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var allActivedModals=[];exports.allActivedModals=allActivedModals;var msgQueue=[];exports.msgQueue=msgQueue;var _default2={name:"VxeModal",mixins:[_size.default],props:{value:Boolean,id:String,type:{type:String,default:"modal"},loading:{type:Boolean,default:null},status:String,iconStatus:String,className:String,top:{type:[Number,String],default:function(){return _conf.default.modal.top}},position:[String,Object],title:String,duration:{type:[Number,String],default:function(){return _conf.default.modal.duration}},message:[String,Function],content:[String,Function],cancelButtonText:{type:String,default:function(){return _conf.default.modal.cancelButtonText}},confirmButtonText:{type:String,default:function(){return _conf.default.modal.confirmButtonText}},lockView:{type:Boolean,default:function(){return _conf.default.modal.lockView}},lockScroll:Boolean,mask:{type:Boolean,default:function(){return _conf.default.modal.mask}},maskClosable:{type:Boolean,default:function(){return _conf.default.modal.maskClosable}},escClosable:{type:Boolean,default:function(){return _conf.default.modal.escClosable}},resize:{type:Boolean,default:function(){return _conf.default.modal.resize}},showHeader:{type:Boolean,default:function(){return _conf.default.modal.showHeader}},showFooter:{type:Boolean,default:function(){return _conf.default.modal.showFooter}},showZoom:{type:Boolean,default:null},showClose:{type:Boolean,default:function(){return _conf.default.modal.showClose}},dblclickZoom:{type:Boolean,default:function(){return _conf.default.modal.dblclickZoom}},width:[Number,String],height:[Number,String],minWidth:{type:[Number,String],default:function(){return _conf.default.modal.minWidth}},minHeight:{type:[Number,String],default:function(){return _conf.default.modal.minHeight}},zIndex:Number,marginSize:{type:[Number,String],default:function(){return _conf.default.modal.marginSize}},fullscreen:Boolean,draggable:{type:Boolean,default:function(){return _conf.default.modal.draggable}},remember:{type:Boolean,default:function(){return _conf.default.modal.remember}},destroyOnClose:{type:Boolean,default:function(){return _conf.default.modal.destroyOnClose}},showTitleOverflow:{type:Boolean,default:function(){return _conf.default.modal.showTitleOverflow}},transfer:{type:Boolean,default:function(){return _conf.default.modal.transfer}},storage:{type:Boolean,default:function(){return _conf.default.modal.storage}},storageKey:{type:String,default:function(){return _conf.default.modal.storageKey}},animat:{type:Boolean,default:function(){return _conf.default.modal.animat}},size:{type:String,default:function(){return _conf.default.modal.size||_conf.default.size}},beforeHideMethod:{type:Function,default:function(){return _conf.default.modal.beforeHideMethod}},slots:Object,events:Object},data:function(){return{inited:!1,visible:!1,contentVisible:!1,modalTop:0,modalZindex:0,zoomLocat:null,firstOpen:!1}},computed:{isMsg:function(){return"message"===this.type}},watch:{width:function(){this.recalculate()},height:function(){this.recalculate()},value:function(t){this[t?"open":"close"]("model")}},created:function(){this.storage&&!this.id&&(0,_log.errLog)("vxe.error.reqProp",["modal.id"])},mounted:function(){var t=this.$listeners,e=this.events,o=void 0===e?{}:e;this.value&&this.open(),this.recalculate(),this.escClosable&&_event.GlobalEvent.on(this,"keydown",this.handleGlobalKeydownEvent);var i="inserted",n={type:i,$modal:this,$event:{type:i}};t.inserted?this.$emit("inserted",n):o.inserted&&o.inserted.call(this,n)},beforeDestroy:function(){var t=this.$el;_event.GlobalEvent.off(this,"keydown"),this.removeMsgQueue(),t.parentNode===document.body&&t.parentNode.removeChild(t)},render:function(e){var t,o=this,i=this._e,n=this.$scopedSlots,s=this.slots,a=void 0===s?{}:s,l=this.inited,r=this.vSize,c=this.className,u=this.type,d=this.resize,f=this.showClose,h=this.showZoom,m=this.animat,p=this.draggable,v=this.loading,g=this.status,y=this.iconStatus,x=this.showFooter,b=this.zoomLocat,_=this.modalTop,w=this.dblclickZoom,S=this.contentVisible,z=this.visible,k=this.title,$=this.lockScroll,M=this.lockView,T=this.mask,B=this.isMsg,O=this.showTitleOverflow,N=this.destroyOnClose,P=this.content||this.message,L=n.default||a.default,A=n.footer||a.footer,E=n.header||a.header,C=n.title||a.title,Z={};return p&&(Z.mousedown=this.mousedownEvent),h&&w&&"modal"===u&&(Z.dblclick=this.toggleZoomEvent),e("div",{class:["vxe-modal--wrapper","type--".concat(u),c||"",(t={},_defineProperty(t,"size--".concat(r),r),_defineProperty(t,"status--".concat(g),g),_defineProperty(t,"is--animat",m),_defineProperty(t,"lock--scroll",$),_defineProperty(t,"lock--view",M),_defineProperty(t,"is--resize",d),_defineProperty(t,"is--mask",T),_defineProperty(t,"is--maximize",b),_defineProperty(t,"is--visible",S),_defineProperty(t,"is--active",z),_defineProperty(t,"is--loading",v),t)],style:{zIndex:this.modalZindex,top:_?"".concat(_,"px"):null},on:{click:this.selfClickEvent}},[e("div",{class:"vxe-modal--box",on:{mousedown:this.boxMousedownEvent},ref:"modalBox"},[this.showHeader?e("div",{class:["vxe-modal--header",{"is--drag":p,"is--ellipsis":!B&&O}],on:Z},E?!l||N&&!z?[]:E.call(this,{$modal:this},e):[C?C.call(this,{$modal:this},e):e("span",{class:"vxe-modal--title"},k?(0,_utils.getFuncText)(k):_conf.default.i18n("vxe.alert.title")),h?e("i",{class:["vxe-modal--zoom-btn","trigger--btn",b?_conf.default.icon.MODAL_ZOOM_OUT:_conf.default.icon.MODAL_ZOOM_IN],attrs:{title:_conf.default.i18n("vxe.modal.zoom".concat(b?"Out":"In"))},on:{click:this.toggleZoomEvent}}):i(),f?e("i",{class:["vxe-modal--close-btn","trigger--btn",_conf.default.icon.MODAL_CLOSE],attrs:{title:_conf.default.i18n("vxe.modal.close")},on:{click:this.closeEvent}}):i()]):null,e("div",{class:"vxe-modal--body"},[g?e("div",{class:"vxe-modal--status-wrapper"},[e("i",{class:["vxe-modal--status-icon",y||_conf.default.icon["MODAL_".concat(g).toLocaleUpperCase()]]})]):null,e("div",{class:"vxe-modal--content"},L?!l||N&&!z?[]:L.call(this,{$modal:this},e):(0,_utils.getFuncText)(P)),B?null:e("div",{class:["vxe-loading",{"is--visible":v}]},[e("div",{class:"vxe-loading--spinner"})])]),x?e("div",{class:"vxe-modal--footer"},A?!l||N&&!z?[]:A.call(this,{$modal:this},e):["confirm"===u?e("vxe-button",{ref:"cancelBtn",on:{click:this.cancelEvent}},this.cancelButtonText||_conf.default.i18n("vxe.button.cancel")):null,e("vxe-button",{ref:"confirmBtn",props:{status:"primary"},on:{click:this.confirmEvent}},this.confirmButtonText||_conf.default.i18n("vxe.button.confirm"))]):null,!B&&d?e("span",{class:"vxe-modal--resize"},["wl","wr","swst","sest","st","swlb","selb","sb"].map(function(t){return e("span",{class:"".concat(t,"-resize"),attrs:{type:t},on:{mousedown:o.dragEvent}})})):null])])},methods:{recalculate:function(){var t=this.width,e=this.height,o=this.getBox();return o.style.width=t?isNaN(t)?t:"".concat(t,"px"):null,o.style.height=e?isNaN(e)?e:"".concat(e,"px"):null,this.$nextTick()},selfClickEvent:function(t){if(this.maskClosable&&t.target===this.$el){this.close("mask")}},updateZindex:function(){var t=this.zIndex,e=this.modalZindex;t?this.modalZindex=t:e<_utils.default.getLastZIndex()&&(this.modalZindex=_utils.default.nextZIndex())},closeEvent:function(t){var e=this.events,o=void 0===e?{}:e,i="close",n={type:i,$modal:this,$event:t};o[i]?o[i].call(this,n):this.$emit(i,n),this.close(i)},confirmEvent:function(t){var e=this.events,o=void 0===e?{}:e,i="confirm",n={type:i,$modal:this,$event:t};o[i]?o[i].call(this,n):this.$emit(i,n),this.close(i)},cancelEvent:function(t){var e=this.events,o=void 0===e?{}:e,i="cancel",n={type:i,$modal:this,$event:t};o[i]?o[i].call(this,n):this.$emit(i,n),this.close(i)},open:function(){var o=this,i=this.$refs,t=this.events,n=void 0===t?{}:t,e=this.inited,s=this.duration,a=this.visible,l=this.isMsg,r=this.remember,c=this.showFooter;e||(this.inited=!0,this.transfer&&document.body.appendChild(this.$el)),a||(r||this.recalculate(),this.visible=!0,this.contentVisible=!1,this.updateZindex(),allActivedModals.push(this),setTimeout(function(){o.contentVisible=!0,o.$nextTick(function(){if(c){var t=i.confirmBtn||i.cancelBtn;t&&t.focus()}var e={type:"",$modal:o};n.show?n.show.call(o,e):(o.$emit("input",!0),o.$emit("show",e))})},10),l?(this.addMsgQueue(),-1!==s&&setTimeout(function(){return o.close("close")},_xeUtils.default.toNumber(s))):this.$nextTick(function(){var t=o.firstOpen,e=o.fullscreen;r&&t||o.updatePosition().then(function(){setTimeout(function(){return o.updatePosition()},20)}),t||(o.firstOpen=!0,o.hasPosStorage()?o.restorePosStorage():e&&o.$nextTick(function(){return o.maximize()}))}))},addMsgQueue:function(){-1===msgQueue.indexOf(this)&&msgQueue.push(this),this.updateStyle()},removeMsgQueue:function(){var e=this;-1<msgQueue.indexOf(this)&&_xeUtils.default.remove(msgQueue,function(t){return t===e}),this.updateStyle()},updateStyle:function(){this.$nextTick(function(){var e=0;msgQueue.forEach(function(t){e+=_xeUtils.default.toNumber(t.top),t.modalTop=e,e+=t.$refs.modalBox.clientHeight})})},updatePosition:function(){var f=this;return this.$nextTick().then(function(){var t=f.marginSize,e=f.position,o=f.getBox(),i=document.documentElement.clientWidth||document.body.clientWidth,n=document.documentElement.clientHeight||document.body.clientHeight,s="center"===e,a=s?{top:e,left:e}:Object.assign({},e),l=a.top,r=a.left,c=s||"center"===l,u="",d="";d=r&&!(s||"center"===r)?isNaN(r)?r:"".concat(r,"px"):"".concat(Math.max(t,i/2-o.offsetWidth/2),"px"),u=l&&!c?isNaN(l)?l:"".concat(l,"px"):"".concat(Math.max(t,n/2-o.offsetHeight/2),"px"),o.style.top=u,o.style.left=d})},close:function(t){var e=this,o=this.events,i=void 0===o?{}:o,n=this.remember,s=this.visible,a=this.isMsg,l=this.beforeHideMethod,r={type:t,$modal:this};s&&Promise.resolve(l?l(r):null).then(function(t){_xeUtils.default.isError(t)||(a&&e.removeMsgQueue(),e.contentVisible=!1,n||(e.zoomLocat=null),_xeUtils.default.remove(allActivedModals,function(t){return t===e}),e.$emit("before-hide",r),setTimeout(function(){e.visible=!1,i.hide?i.hide.call(e,r):(e.$emit("input",!1),e.$emit("hide",r))},200))}).catch(function(t){return t})},handleGlobalKeydownEvent:function(t){var e=this;if(27===t.keyCode){var o=_xeUtils.default.max(allActivedModals,function(t){return t.modalZindex});o&&setTimeout(function(){o===e&&o.escClosable&&e.close("exit")},10)}},getBox:function(){return this.$refs.modalBox},isMaximized:function(){return!!this.zoomLocat},maximize:function(){var s=this;return this.$nextTick().then(function(){if(!s.zoomLocat){var t=Math.max(0,s.marginSize),e=s.getBox(),o=_dom.default.getDomNode(),i=o.visibleHeight,n=o.visibleWidth;s.zoomLocat={top:e.offsetTop,left:e.offsetLeft,width:e.offsetWidth+(e.style.width?0:1),height:e.offsetHeight+(e.style.height?0:1)},Object.assign(e.style,{top:"".concat(t,"px"),left:"".concat(t,"px"),width:"".concat(n-2*t,"px"),height:"".concat(i-2*t,"px")}),s.savePosStorage()}})},revert:function(){var o=this;return this.$nextTick().then(function(){var t=o.zoomLocat;if(t){var e=o.getBox();o.zoomLocat=null,Object.assign(e.style,{top:"".concat(t.top,"px"),left:"".concat(t.left,"px"),width:"".concat(t.width,"px"),height:"".concat(t.height,"px")}),o.savePosStorage()}})},zoom:function(){var t=this;return this[this.zoomLocat?"revert":"maximize"]().then(function(){return t.isMaximized()})},toggleZoomEvent:function(t){var e=this,o=this.$listeners,i=this.zoomLocat,n=this.events,s=void 0===n?{}:n,a={type:i?"revert":"max",$modal:this,$event:t};return this.zoom().then(function(){o.zoom?e.$emit("zoom",a):s.zoom&&s.zoom.call(e,a)})},getPosition:function(){if(!this.isMsg){var t=this.getBox();if(t)return{top:t.offsetTop,left:t.offsetLeft}}return null},setPosition:function(t,e){if(!this.isMsg){var o=this.getBox();_xeUtils.default.isNumber(t)&&(o.style.top="".concat(t,"px")),_xeUtils.default.isNumber(e)&&(o.style.left="".concat(e,"px"))}return this.$nextTick()},boxMousedownEvent:function(){var e=this.modalZindex;allActivedModals.some(function(t){return t.visible&&t.modalZindex>e})&&this.updateZindex()},mousedownEvent:function(t){var e=this,o=this.remember,i=this.storage,c=this.marginSize,n=this.zoomLocat,u=this.getBox();if(!n&&0===t.button&&!_dom.default.getEventTargetNode(t,u,"trigger--btn").flag){t.preventDefault();var s=document.onmousemove,a=document.onmouseup,d=t.clientX-u.offsetLeft,f=t.clientY-u.offsetTop,l=_dom.default.getDomNode(),h=l.visibleHeight,m=l.visibleWidth;document.onmousemove=function(t){t.preventDefault();var e=u.offsetWidth,o=u.offsetHeight,i=c,n=m-e-c-1,s=c,a=h-o-c-1,l=t.clientX-d,r=t.clientY-f;n<l&&(l=n),l<i&&(l=i),a<r&&(r=a),r<s&&(r=s),u.style.left="".concat(l,"px"),u.style.top="".concat(r,"px")},document.onmouseup=function(){document.onmousemove=s,document.onmouseup=a,o&&i&&e.$nextTick(function(){e.savePosStorage()})}}},dragEvent:function(t){var s=this;t.preventDefault();var a=this.$listeners,l=this.marginSize,e=this.events,r=void 0===e?{}:e,c=this.remember,u=this.storage,o=_dom.default.getDomNode(),d=o.visibleHeight,f=o.visibleWidth,h=t.target.getAttribute("type"),m=_xeUtils.default.toNumber(this.minWidth),p=_xeUtils.default.toNumber(this.minHeight),v=f,g=d,y=this.getBox(),i=document.onmousemove,n=document.onmouseup,x=y.clientWidth,b=y.clientHeight,_=t.clientX,w=t.clientY,S=y.offsetTop,z=y.offsetLeft,k={type:"resize",$modal:this};document.onmousemove=function(t){var e,o,i,n;switch(t.preventDefault(),h){case"wl":i=(e=_-t.clientX)+x,l<z-e&&m<i&&(y.style.width="".concat(i<v?i:v,"px"),y.style.left="".concat(z-e,"px"));break;case"swst":e=_-t.clientX,o=w-t.clientY,i=e+x,n=o+b,l<z-e&&m<i&&(y.style.width="".concat(i<v?i:v,"px"),y.style.left="".concat(z-e,"px")),l<S-o&&p<n&&(y.style.height="".concat(n<g?n:g,"px"),y.style.top="".concat(S-o,"px"));break;case"swlb":e=_-t.clientX,o=t.clientY-w,i=e+x,n=o+b,l<z-e&&m<i&&(y.style.width="".concat(i<v?i:v,"px"),y.style.left="".concat(z-e,"px")),S+n+l<d&&p<n&&(y.style.height="".concat(n<g?n:g,"px"));break;case"st":o=w-t.clientY,n=b+o,l<S-o&&p<n&&(y.style.height="".concat(n<g?n:g,"px"),y.style.top="".concat(S-o,"px"));break;case"wr":e=t.clientX-_,z+(i=e+x)+l<f&&m<i&&(y.style.width="".concat(i<v?i:v,"px"));break;case"sest":e=t.clientX-_,n=(o=w-t.clientY)+b,z+(i=e+x)+l<f&&m<i&&(y.style.width="".concat(i<v?i:v,"px")),l<S-o&&p<n&&(y.style.height="".concat(n<g?n:g,"px"),y.style.top="".concat(S-o,"px"));break;case"selb":e=t.clientX-_,n=(o=t.clientY-w)+b,z+(i=e+x)+l<f&&m<i&&(y.style.width="".concat(i<v?i:v,"px")),S+n+l<d&&p<n&&(y.style.height="".concat(n<g?n:g,"px"));break;case"sb":o=t.clientY-w,S+(n=o+b)+l<d&&p<n&&(y.style.height="".concat(n<g?n:g,"px"))}y.className=y.className.replace(/\s?is--drag/,"")+" is--drag",c&&u&&s.savePosStorage(),a.zoom?s.$emit("zoom",k):r.zoom&&r.zoom.call(s,k)},document.onmouseup=function(){s.zoomLocat=null,document.onmousemove=i,document.onmouseup=n,setTimeout(function(){y.className=y.className.replace(/\s?is--drag/,"")},50)}},getStorageMap:function(t){var e=_conf.default.version,o=_xeUtils.default.toStringJSON(localStorage.getItem(t));return o&&o._v===e?o:{_v:e}},hasPosStorage:function(){var t=this.id,e=this.remember,o=this.storage,i=this.storageKey;return!!(e&&o&&this.getStorageMap(i)[t])},restorePosStorage:function(){var t=this.id,e=this.remember,o=this.storage,i=this.storageKey;if(e&&o){var n=this.getStorageMap(i)[t];if(n){var s=this.getBox(),a=_slicedToArray(n.split(","),8),l=a[0],r=a[1],c=a[2],u=a[3],d=a[4],f=a[5],h=a[6],m=a[7];l&&(s.style.left="".concat(l,"px")),r&&(s.style.top="".concat(r,"px")),c&&(s.style.width="".concat(c,"px")),u&&(s.style.height="".concat(u,"px")),d&&f&&(this.zoomLocat={left:d,top:f,width:h,height:m})}}},savePosStorage:function(){var t=this.id,e=this.remember,o=this.storage,i=this.storageKey,n=this.zoomLocat;if(e&&o){var s=this.getBox(),a=this.getStorageMap(i);a[t]=[s.style.left,s.style.top,s.style.width,s.style.height].concat(n?[n.left,n.top,n.width,n.height]:[]).map(function(t){return t?_xeUtils.default.toNumber(t):""}).join(","),localStorage.setItem(i,_xeUtils.default.toJSONString(a))}}}};exports.default=_default2;